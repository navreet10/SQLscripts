--- Customers
drop table customers;
drop table companies;
drop table state;
drop table position;
drop table cities;

SELECT COUNT(DISTINCT company) FROM customers;

                                  
CREATE TABLE Companies
  (
    companyid NUMBER generated BY DEFAULT ON NULL AS identity,
    company VARCHAR(50)
  );
INSERT INTO Companies
  (COMPANY
  )
SELECT DISTINCT company FROM customers;

ALTER TABLE customers ADD CompanyID INT;

UPDATE customers c
SET c.companyID =
  (SELECT t.companyID FROM Companies t WHERE t.company=c.company
  );
  
SELECT companyID, company FROM CUSTOMERS;
SELECT * FROM COMPANIES ORDER BY COMPANY;


ALTER TABLE customers
DROP column company;

ALTER TABLE customers
DROP column fullname;

CREATE TABLE Cities
  (
  cityid NUMBER generated BY DEFAULT ON NULL AS identity,
  city VARCHAR(50)
  );
  
-- added city ID to cities and generated sequence
INSERT INTO cities
  (city
  )
SELECT DISTINCT city FROM customers;

ALTER TABLE customers ADD cityid INT;

UPDATE customers c
SET c.cityid =
  (SELECT t.cityid FROM cities t WHERE t.city=c.city
  );
  
ALTER TABLE customers
DROP column city;




----
CREATE TABLE States
  (
    stateid NUMBER generated BY DEFAULT ON NULL AS identity,
    state   VARCHAR(30)
  );
ALTER TABLE state ADD CONSTRAINT state_pk PRIMARY KEY(stateid);
--CREATE SEQUENCE state_seq
-- START WITH     1000
-- INCREMENT BY   1
-- NOCACHE
-- NOCYCLE;
--drop SEQUENCE state_seq;
--drop table state;
INSERT
INTO states
  (
    state
  )
SELECT DISTINCT state FROM customers;

ALTER TABLE customers ADD stateid    INT;

UPDATE customers c
SET c.stateid =
  (SELECT t.stateid FROM states t WHERE t.state=c.state
  );
  
ALTER TABLE customers
DROP column state;
-----
CREATE TABLE Positions
  (
    positionid NUMBER generated BY DEFAULT ON NULL AS identity,
    position   VARCHAR(60)
  );
--DROP TABLE position;
INSERT INTO positions
  (position
  )
SELECT DISTINCT position FROM customers;

ALTER TABLE customers ADD positionid INT;

UPDATE customers c
SET c.positionid =
  (SELECT t.positionid FROM positions t WHERE t.position=c.position
  );
  
ALTER TABLE customers
DROP column position;

commit;
--- Put it back

SELECT a.title,
  (a.firstname
    || ' '
    || a.lastname) AS "Full Name",
      e.company,
      a.streetaddress,
      b.city,
      c.state,
      a.zipcode,
      a.emailaddress,
      d.position
FROM customers a
JOIN companies e
ON a.companyID = e.companyid
JOIN cities b
ON a.companyID = e.companyid
JOIN states c
ON a.stateid = c.stateid
JOIN positions d
ON a.positionid  = d.positionid
ORDER BY a.firstname ASC;

SELECT emailaddress AS "Full Name"
FROM customers
WHERE emailaddress NOT IN
  (SELECT a.EMAILADDRESS
--  (a.firstname
--    || ' '
--    || a.lastname) AS "Full Name"--,
--    --  e.company,
    --  a.streetaddress,
    --  b.city,
    --  c.state,
    --  a.zipcode,
    --  a.emailaddress,
    --  d.position
FROM customers a
JOIN companies e
ON a.companyID = e.companyid
JOIN cities b
ON a.companyID = e.companyid
JOIN states c
ON a.stateid = c.stateid
JOIN positions d
ON a.positionid  = d.positionid

  --ORDER BY a.firstname ASC
  ) ;

select * from CUSTOMERS where EMAILADDRESS in ('JacobSEng@teleworm.us',
'GaryBMillman@jourrapide.com',
'AlanRLewis@cuvox.de',
'RuthJWerner@superrito.com');


SELECT DISTINCT a.title,
  (a.firstname
  || ' '
  || a.lastname) AS "Full Name",
  e.company,
  a.streetaddress,
  b.city,
  c.state,
  a.zipcode,
  a.emailaddress,
  d.position
FROM customers a
JOIN companies e
ON a.companyID = e.companyid
JOIN cities b
ON a.companyID = e.companyid
JOIN states c
ON a.stateid = c.stateid
JOIN positions d
ON a.positionid  = d.positionid
WHERE a.LASTNAME = 'Smith';

SELECT distinct a.title,
  (a.firstname
  || ' ' || a.lastname) AS "Full Name",
  e.company,
  a.streetaddress,
  b.city,
  c.state,
  a.zipcode,
  a.emailaddress,
  d.position
FROM customers a
JOIN companies e
ON a.companyID = e.companyid
JOIN cities b
ON a.companyID = e.companyid
JOIN states c
ON a.stateid = c.stateid
JOIN positions d
ON a.positionid  = d.positionid
WHERE b.city = 'Toledo';

SELECT distinct a.title,
  (a.firstname
  || ' ' || a.lastname) AS "Full Name",
  e.company,
  a.streetaddress,
  b.city,
  c.state,
  a.zipcode,
  a.emailaddress,
  d.position
FROM customers a
JOIN companies e
ON a.companyID = e.companyid
JOIN cities b
ON a.companyID = e.companyid
JOIN states c
ON a.stateid = c.stateid
JOIN positions d
ON a.positionid  = d.positionid
WHERE b.city = 'Virginia Beach';


UPDATE CUSTOMERS
SET LASTNAME    = 'Smith'
WHERE FIRSTNAME = 'Paula'
AND LASTNAME    = 'Hill'
AND CITYID     IN
  (SELECT cityid FROM cities WHERE city ='Anaheim'
  )
AND STATEID IN
  (SELECT stateid FROM states WHERE state ='CA'
  );

--Select * from CUSTOMERS where FIRSTNAME = 'Paula';


UPDATE CUSTOMERS
SET LASTNAME    = 'Smith'
WHERE FIRSTNAME = 'Vanessa'
AND LASTNAME    = 'Brown';


SELECT COUNT(*) FROM CUSTOMERS WHERE LASTNAME = 'Smith';

SELECT * FROM customers WHERE LastName LIKE 'S%'; 

commit;

SELECT *
FROM
  (SELECT COUNT( DISTINCT a.COMPANYID) AS "Total Number",
    c.state
  FROM Customers a,
    states c
  WHERE a.stateid = c.stateid
  GROUP BY c.state
  ORDER BY "Total Number" DESC
  )
WHERE rownum <=5 ;

commit;


SELECT a.title,
  (a.firstname
  || ' '
  || a.lastname) AS "Full Name",
  e.company,
  a.streetaddress,
  b.city,
  c.state,
  a.zipcode,
  a.emailaddress,
  d.position
FROM customers a
JOIN companies e
ON a.companyID = e.companyid
JOIN cities b
ON a.companyID = e.companyid
JOIN states c
ON a.stateid = c.stateid
JOIN positions d
ON a.positionid  = d.positionid
WHERE (d.POSITION   = 'ATF agent'
OR e.COMPANY      = 'Trak Auto');

